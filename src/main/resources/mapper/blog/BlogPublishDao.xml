<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xjtu.dbc.robserver.blog.publish.dao.BlogPublishDao">
    <!-- 根据 ID 获取用户 -->
    <select id="getLastId" resultType="java.lang.Integer">
        select max(articleid)
        from article
    </select>

    <select id="getLastTagId" resultType="java.lang.Integer">
        select max(tagid)
        from tag
    </select>

    <insert id="addBlog">
        INSERT INTO article(articleid, articletype, articlestatus, title, content, cost, createtime, lastmodifytime, replyto, authorid, categoryid, rootid)
        VALUES (#{articleid}, #{articletype}, #{articlestatus}, #{title}, #{content}, #{cost}, #{createtime}, #{lastmodifytime}, #{replyto}, #{authorid}, #{categoryid}, #{rootid});
    </insert>

    <insert id="addTag">
        INSERT INTO tag(tagid,tagname,ownerid)
        VALUES (#{tagid}, #{tagname}, #{ownerid})
    </insert>

    <select id="selectTagListByArtileid" resultType="java.lang.String">
        select tagname
        from article_has_tag,tag
        where articleid=#{articleid} and article_has_tag.tagid = tag.tagid
    </select>

    <select id="selectTagnameListByUserid" resultType="java.lang.String">
        select tagname
        from tag
        where ownerid=#{myid}
    </select>

    <select id="selectTagidUseTagname" resultType="java.lang.Integer">
        select tagid
        from tag
        where ownerid=#{myid} and tagname=#{tagname}
    </select>

    <select id="selectTagListByUserid" resultType="com.xjtu.dbc.robserver.common.model.tag.Tag">
        select *
        from tag
        where ownerid=#{myid}
    </select>

    <update id="updateBlogByArticleid">
        UPDATE article
        SET
            <if test="articlestatus != null">
            articlestatus  = #{articlestatus},
            </if>
            title          = #{title},
            content        = #{content},
            lastmodifytime = #{lastmodifytime},
            categoryid       = #{categoryid}
        WHERE articleid = #{articleid}
    </update>

    <insert id="addTagForBlog">
        INSERT INTO article_has_tag(articleid,tagid)
        VALUES (#{articleid}, #{tagid})
    </insert>

    <delete id="dropTagForBlog">
        DELETE FROM article_has_tag
        WHERE tagid = #{tagid} and articleid=#{articleid}
    </delete>

    <select id="selectBlogDetailDtoByArticleid" resultType="com.xjtu.dbc.robserver.blog.publish.BlogDetailDto">
        select *
        from article
        where articleid=#{articleid}
    </select>

    <select id="selectBlogEditDtoByArticleid" resultType="com.xjtu.dbc.robserver.blog.publish.BlogEditDto">
        select *
        from article
        where articleid=#{articleid}
    </select>

    <select id="selectAuthorByArtileid" resultType="com.xjtu.dbc.robserver.common.model.user.User">
        select userid,username,useravatar
        from article,user
        where userid = authorid and articleid = #{articleid}
    </select>

    <select id="selectUserStatusByAuthorid" resultType="java.lang.Integer">
        select userstatus
        from user
        where userid = #{authorid}
    </select>

    <select id="getArticleStatus" resultType="java.lang.Integer">
        select articlestatus
        from article
        where articleid = #{articleid}
    </select>

    <select id="selectTagCntByT_nameAndU_id" resultType="java.lang.Integer">
        SELECT COUNT(tagid)
        FROM tag
        WHERE tagname = #{t_name} and ownerid = #{u_id}
    </select>

    <update id="updateTagnameByT_nameAndU_id">
        UPDATE tag
        SET tagname = #{t_name_new}
        WHERE tagname = #{tagname} AND ownerid = #{u_id}
    </update>

    <delete id="deleteTagByTagnameAndU_id">
        DELETE FROM tag
        WHERE tagname = #{tagname} and ownerid = #{u_id}
    </delete>

</mapper>